<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>우리집 일상 소개</title>
  <link rel="icon" href="data:,">
  <link rel="stylesheet" href="styles.css" />
  <script type="module" src="https://sclass0614.github.io/authCheck/authCheck.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="supabase.js"></script>

</head>

<body>
  <div class="container">
    <div class="header" id="headerSection">
      <div class="title" id="pageTitle">
        우리집 데이케어 센터 일상 소개
      </div>
    </div>
    <div class="main_content">
      <div class="content-wrapper">
        <div class="table-container">
          <div class="table-header">
            <h2>활동 목록</h2>
            <div class="reference-date-container">
              <input type="date" class="reference-date-input" name="referenceDate" id="referenceDate" />
            </div>
          </div>
          <table id="activityTable">
            <thead>
              <tr>
                <th>활동명</th>
                <th>시작시간</th>
                <th>종료시간</th>
                <th>참고사진url</th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </div>

        <div class="card-container">
          <h2>활동 카드 미리보기</h2>
          <div class="a4-card" id="activityCard">
            <div class="card-content">
              <div class="card-image">
                <img id="activityImage" src="" alt="활동 이미지">
              </div>

              <div class="activity-info">
                <div class="empty-space"></div>
                <textarea id="activityTitle" class="activity-textarea"></textarea>
                <div class="logo-container">
                  <img src="images/우리집로고.png" alt="우리집 로고" class="logo-image">
                </div>
              </div>
            </div>
          </div>
          <button id="printCard" class="print-button">인쇄하기</button>
        </div>
      </div>
    </div>
  </div>

</body>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const supabase = initSupabase();

    const activityTable = document.getElementById('activityTable');
    const activityTextarea = document.getElementById('activityTitle');
    const activityImage = document.getElementById('activityImage');
    const printButton = document.getElementById('printCard');
    const dateInput = document.getElementById('referenceDate');

    function formatDateToYYYYMMDD(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}${month}${day}`;
    }

    function convertDateFormat(dateStr) {
      return dateStr.replace(/-/g, '');
    }

    const today = new Date();
    const formattedToday = today.toISOString().split('T')[0];

    dateInput.value = formattedToday;

    dateInput.addEventListener('change', function () {
      const selectedDate = convertDateFormat(this.value);
      loadActivitiesByDate(selectedDate);
    });

    async function loadActivitiesByDate(dateStr) {
      try {
        const { data, error } = await supabase
          .from('activities_plan')
          .select('*')
          .eq('날짜', dateStr);

        if (error) {
          return;
        }

        const tbody = activityTable.querySelector('tbody');
        tbody.innerHTML = '';

        if (data && data.length > 0) {
          const sortedData = data.sort((a, b) => {
            if (a.시작시간 < b.시작시간) return -1;
            if (a.시작시간 > b.시작시간) return 1;

            return a.활동명.localeCompare(b.활동명, 'ko');
          });

          sortedData.forEach(activity => {
            addActivityRow({
              id: activity.id,
              name: activity.활동명,
              startTime: activity.시작시간,
              endTime: activity.종료시간,
              imageUrl: activity.참고사진url
            });
          });

          const firstRow = tbody.querySelector('tr');
          if (firstRow) {
            const dblClickEvent = new MouseEvent('dblclick', {
              bubbles: true,
              cancelable: true,
              view: window
            });
            firstRow.dispatchEvent(dblClickEvent);
          }
        } else {
          const emptyRow = document.createElement('tr');
          const emptyCell = document.createElement('td');
          emptyCell.colSpan = 4;
          emptyCell.textContent = '해당 날짜의 활동 데이터가 없습니다.';
          emptyCell.style.textAlign = 'center';
          emptyCell.style.padding = '1rem';
          emptyRow.appendChild(emptyCell);
          tbody.appendChild(emptyRow);
        }
      } catch (error) {
      }
    }

    activityTable.addEventListener('dblclick', function (event) {
      const row = event.target.closest('tr');
      if (!row || !row.dataset.id) return;

      const selectedRows = activityTable.querySelectorAll('tr.selected');
      selectedRows.forEach(row => row.classList.remove('selected'));

      row.classList.add('selected');

      const cells = row.querySelectorAll('td');
      const activityName = cells[0].textContent;
      const imageUrl = cells[3].textContent;

      activityTextarea.value = activityName;

      activityImage.src = imageUrl;
      activityImage.alt = activityName;

      activityImage.onerror = function () {
        this.src = 'placeholder.jpg';
        this.alt = '이미지를 찾을 수 없습니다';
      };
    });

    printButton.addEventListener('click', function () {
      const selectedRow = activityTable.querySelector('tr.selected');
      if (!selectedRow) {
        alert('인쇄할 활동을 먼저 선택해주세요.');
        return;
      }

      const printOptions = {
        printable: 'activityCard',
        type: 'html',
        css: 'styles.css',
        style: '@page { size: A4 landscape; margin: 0; }',
        scanStyles: true
      };

      window.print();
    });

    activityTextarea.addEventListener('dblclick', function () {
      this.focus();
    });

    function addActivityRow(activity) {
      const tbody = activityTable.querySelector('tbody');

      const row = document.createElement('tr');
      row.dataset.id = activity.id;

      const nameCell = document.createElement('td');
      nameCell.textContent = activity.name;

      const startTimeCell = document.createElement('td');
      startTimeCell.textContent = activity.startTime;

      const endTimeCell = document.createElement('td');
      endTimeCell.textContent = activity.endTime;

      const imageUrlCell = document.createElement('td');
      imageUrlCell.textContent = activity.imageUrl;

      row.appendChild(nameCell);
      row.appendChild(startTimeCell);
      row.appendChild(endTimeCell);
      row.appendChild(imageUrlCell);

      tbody.appendChild(row);

      return row;
    }

    const formattedTodayForDB = formatDateToYYYYMMDD(today);
    loadActivitiesByDate(formattedTodayForDB);
  });
</script>

</html>